{# automation/templates/automation/job_form.html #}
{% extends "base.html" %}

{% block title %}
  {% if object %}
    Editar automação · {{ object.name }}
  {% else %}
    Nova automação
  {% endif %}
{% endblock %}

{% block header_title %}
  {% if object %}
    Editar automação
  {% else %}
    Nova automação
  {% endif %}
{% endblock %}

{% block header_subtitle %}
  Configure os parâmetros da automação, agendamento e execução.
{% endblock %}

{% block header_actions %}
  <a href="{% url 'automation:job_list' %}" class="btn btn-outline-light btn-sm">
    Voltar para automações
  </a>
{% endblock %}

{% block extra_css %}
<style>
  .form-section-title {
      font-size: .9rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #9ca3af;
      margin-bottom: .5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card module-card">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}

        {# Erros gerais do form #}
        {% if form.non_field_errors %}
          <div class="alert alert-danger mb-3">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        {# Lista resumida de erros de campos #}
        {% if form.errors %}
          <div class="alert alert-danger mb-3">
            <strong>Verifique os campos com erro:</strong>
            <ul class="mb-0">
              {% for field in form %}
                {% if field.errors %}
                  <li>{{ field.label }}: {{ field.errors|striptags }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="row">
          <div class="col-md-8">
            <div class="form-section-title">Dados básicos</div>

            <div class="mb-3">
              <label class="form-label" for="{{ form.name.id_for_label }}">Nome</label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="{{ form.description.id_for_label }}">Descrição</label>
              {{ form.description }}
              {% if form.description.errors %}
                <div class="text-danger small">{{ form.description.errors }}</div>
              {% endif %}
            </div>

            {# Setor #}
            {% if form.sector %}
              <div class="mb-3">
                <label class="form-label" for="{{ form.sector.id_for_label }}">Setor</label>
                {{ form.sector }}
                {% if form.sector.help_text %}
                  <div class="form-text">{{ form.sector.help_text }}</div>
                {% endif %}
                {% if form.sector.errors %}
                  <div class="text-danger small">{{ form.sector.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <div class="form-section-title">Opções</div>

            <div class="form-check mb-2">
              {{ form.is_active }}
              <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                Automação ativa
              </label>
              {% if form.is_active.errors %}
                <div class="text-danger small">{{ form.is_active.errors }}</div>
              {% endif %}
            </div>

            <div class="form-check mb-3">
              {{ form.allow_manual }}
              <label class="form-check-label" for="{{ form.allow_manual.id_for_label }}">
                Permitir disparo manual
              </label>
              {% if form.allow_manual.errors %}
                <div class="text-danger small">{{ form.allow_manual.errors }}</div>
              {% endif %}
            </div>

            {% if form.external_main_script %}
              <div class="mb-3">
                <label class="form-label" for="{{ form.external_main_script.id_for_label }}">
                  Script principal
                </label>
                {{ form.external_main_script }}
                <div class="form-text">
                  Arquivo Python principal dentro da pasta da automação (ex.: <code>main.py</code>).
                </div>
                {% if form.external_main_script.errors %}
                  <div class="text-danger small">{{ form.external_main_script.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <hr class="my-4">

        <div class="row">
          <div class="col-md-8">
            <div class="form-section-title">Agendamento</div>

            <div class="mb-3">
              <label class="form-label" for="{{ form.schedule_type.id_for_label }}">
                Tipo de agendamento
              </label>
              {{ form.schedule_type }}
              {% if form.schedule_type.help_text %}
                <div class="form-text">{{ form.schedule_type.help_text }}</div>
              {% endif %}
              {% if form.schedule_type.errors %}
                <div class="text-danger small">{{ form.schedule_type.errors }}</div>
              {% endif %}
            </div>

            {# Pontual #}
            {% if form.one_off_run_at %}
              <div class="mb-3" id="field_one_off_run_at">
                <label class="form-label" for="{{ form.one_off_run_at.id_for_label }}">
                  Data/hora única (pontual)
                </label>
                {{ form.one_off_run_at }}
                {% if form.one_off_run_at.help_text %}
                  <div class="form-text">{{ form.one_off_run_at.help_text }}</div>
                {% endif %}
                {% if form.one_off_run_at.errors %}
                  <div class="text-danger small">{{ form.one_off_run_at.errors }}</div>
                {% endif %}
              </div>
            {% endif %}

            {# Diário – um horário #}
            <div class="mb-3" id="field_daily_time">
              <label class="form-label" for="{{ form.daily_time.id_for_label }}">
                Horário diário
              </label>
              {{ form.daily_time }}
              {% if form.daily_time.help_text %}
                <div class="form-text">{{ form.daily_time.help_text }}</div>
              {% endif %}
              {% if form.daily_time.errors %}
                <div class="text-danger small">{{ form.daily_time.errors }}</div>
              {% endif %}
            </div>

            {# Diário – vários horários #}
            <div class="mb-3" id="field_multi_daily_times">
              <label class="form-label" for="{{ form.multi_daily_times.id_for_label }}">
                Horários diários (lista)
              </label>
              {{ form.multi_daily_times }}
              {% if form.multi_daily_times.help_text %}
                <div class="form-text">
                  {{ form.multi_daily_times.help_text }}
                </div>
              {% else %}
                <div class="form-text">
                  Informe horários HH:MM separados por vírgula. Ex.: <code>08:00, 13:00, 18:00</code>
                </div>
              {% endif %}
              {% if form.multi_daily_times.errors %}
                <div class="text-danger small">{{ form.multi_daily_times.errors }}</div>
              {% endif %}
            </div>

            {# Intervalo em minutos #}
            <div class="mb-3" id="field_interval_minutes">
              <label class="form-label" for="{{ form.interval_minutes.id_for_label }}">
                Intervalo (minutos)
              </label>
              {{ form.interval_minutes }}
              {% if form.interval_minutes.help_text %}
                <div class="form-text">{{ form.interval_minutes.help_text }}</div>
              {% endif %}
              {% if form.interval_minutes.errors %}
                <div class="text-danger small">{{ form.interval_minutes.errors }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="{{ form.next_run_at.id_for_label }}">
                Próxima execução
              </label>
              {{ form.next_run_at }}
              {% if form.next_run_at.help_text %}
                <div class="form-text">{{ form.next_run_at.help_text }}</div>
              {% endif %}
              {% if form.next_run_at.errors %}
                <div class="text-danger small">{{ form.next_run_at.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="mt-4 d-flex justify-content-between">
          <a href="{% url 'automation:job_list' %}" class="btn btn-outline-secondary">
            Cancelar
          </a>
          <button type="submit" class="btn btn-accent">
            Salvar automação
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectType     = document.getElementById("id_schedule_type");
    const dailyField     = document.getElementById("field_daily_time");
    const multiField     = document.getElementById("field_multi_daily_times");
    const intervalField  = document.getElementById("field_interval_minutes");
    const onceField      = document.getElementById("field_one_off_run_at");

    function show(el, show) {
        if (!el) return;
        el.style.display = show ? "block" : "none";
    }

    function toggleScheduleFields() {
        if (!selectType) return;
        const v = selectType.value;

        // zera tudo
        show(dailyField,    false);
        show(multiField,    false);
        show(intervalField, false);
        show(onceField,     false);

        if (v === "once") {
            show(onceField, true);
        } else if (v === "daily") {
            show(dailyField, true);
        } else if (v === "multi_daily") {
            show(multiField, true);
        } else if (v === "interval") {
            show(intervalField, true);
        }
    }

    toggleScheduleFields();
    if (selectType) {
        selectType.addEventListener("change", toggleScheduleFields);
    }
});
</script>
{% endblock %}
