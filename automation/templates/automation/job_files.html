{# automation/templates/automation/job_files.html #}
{% extends "base.html" %}

{% block title %}Arquivos – {{ job.name }} · Orquestrador{% endblock %}

{% block header_title %}
    Arquivos da automação – {{ job.name }}
{% endblock %}

{% block header_subtitle %}
    Pasta física atual:
    <code>{{ current_path_display }}</code><br>
    Script principal:
    <code>{{ job.external_main_script }}</code>
{% endblock %}

{% block header_actions %}
<a href="{% url 'automation:job_list' %}" class="btn btn-outline-light btn-sm">
    Voltar para automações
</a>
<a href="{% url 'automation:job_runs' job.pk %}" class="btn btn-outline-light btn-sm">
    Ver execuções
</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card module-card h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3">Enviar arquivos</h5>
                    <p class="text-muted small">
                        Os arquivos selecionados serão salvos diretamente em
                        <code>{{ current_path_display }}</code>.
                    </p>

                    <form method="post" enctype="multipart/form-data" class="mt-3">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label" for="id_files">
                                Selecione um ou mais arquivos
                            </label>
                            {{ form.files }}
                            {% if form.files.errors %}
                                <div class="text-danger small">
                                    {{ form.files.errors.0 }}
                                </div>
                            {% endif %}
                            <small class="text-muted d-block">
                                Os arquivos selecionados serão salvos diretamente em
                                <code>{{ current_path_display }}</code>.
                            </small>
                        </div>

                        <button type="submit" class="btn btn-warning btn-lg w-100">
                            Enviar arquivos
                        </button>
                    </form>

                    {# ====== BOTÕES RESTRITOS AO GRUPO administrador_Orquestrador ====== #}
                    {% if is_orq_admin %}
                        {# ✅ Resetar a venv desse job #}
                        <form method="post" action="{% url 'automation:job_reset_venv' job.pk %}" class="mt-2">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-danger w-100"
                                    onclick="return confirm('Isso vai apagar a .venv desse job. Confirmar?');">
                                Resetar venv
                            </button>
                        </form>

                        {# ✅ Resetar workspace (mantém as pastas entrada/ e saida/, mas limpa tudo dentro e apaga o resto) #}
                        <form method="post" action="{% url 'automation:job_reset_workspace' job.pk %}" class="mt-2">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-danger w-100"
                                    onclick="return confirm('Isso vai APAGAR tudo do job (incluindo .venv, scripts, requirements) e LIMPAR o conteúdo de entrada/ e saida/. Confirmar?');">
                                Resetar workspace (limpar tudo)
                            </button>

                            <small class="text-muted d-block mt-1">
                                Mantém as pastas <code>entrada/</code> e <code>saida/</code>, mas apaga todos os arquivos dentro delas.
                            </small>
                        </form>

                        {# ✅ Resetar pasta (apaga tudo fora de entrada/saida, mas NÃO limpa conteúdo delas) #}
                        <form method="post" action="{% url 'automation:job_reset_folder' job.pk %}" class="mt-2">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-outline-danger w-100"
                                    onclick="return confirm('Isso vai remover tudo da pasta do job, exceto as pastas entrada/ e saida/ (conteúdo delas será mantido). Confirmar?');">
                                Resetar pasta (manter conteúdo de entrada/saida)
                            </button>
                        </form>
                    {% endif %}
                    {# ================================================================ #}

                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card module-card h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3">Arquivos atuais</h5>

                    {% if files %}
                        <div class="table-responsive">
                            <table class="table table-clean align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th class="text-end">Tamanho</th>
                                        <th>Modificado em</th>
                                        <th class="text-end">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for f in files %}
                                    <tr>
                                        <td>
                                            {% if f.is_dir and f.subdir_param %}
                                                <a href="{% url 'automation:job_files' job.pk %}?subdir={{ f.subdir_param|urlencode }}"
                                                   class="text-decoration-none">
                                                    <i class="bi bi-folder-fill me-1"></i>{{ f.name }}/
                                                </a>
                                            {% elif f.is_dir %}
                                                <i class="bi bi-folder-fill me-1"></i>{{ f.name }}/
                                            {% else %}
                                                <i class="bi bi-file-earmark-text me-1"></i>{{ f.name }}
                                            {% endif %}
                                        </td>

                                        <td class="text-end">
                                            {% if not f.is_dir %}
                                                {{ f.size|filesizeformat }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>

                                        <td>
                                            {{ f.modified|date:"d/m/Y H:i" }}
                                        </td>

                                        <td class="text-end">
                                            {% if not f.is_dir and f.can_download %}
                                                <a class="btn btn-sm btn-outline-primary"
                                                   href="{% url 'automation:job_file_download' job.pk %}?subdir={{ current_subdir|urlencode }}&name={{ f.name|urlencode }}">
                                                    <i class="bi bi-download"></i> Baixar
                                                </a>
                                            {% else %}
                                                <span class="text-muted small">—</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">
                            Ainda não há arquivos nessa pasta (além da venv ou arquivos ocultos).
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
